{% extends 'base.html.twig' %}

{# --- 1. Configuration des variables --- #}
{% set statTitle = 'Statistiques' %}
{% set caption = 'Valeur' %}
{% set toEuros = 1 %}
{% set euroSign = '' %}
{% set chartColor = '#3498db' %}
{% set chartBgColor = 'rgba(52, 152, 219, 0.2)' %}

{% if statistics is defined and statistics is not empty %}
    {% if statistics[0].statisticType == 'NB_COMMANDES' %}
        {% set statTitle = 'Volume de Commandes' %}
        {% set caption = "Commandes" %}
        {% set chartColor = '#e67e22' %}
        {% set chartBgColor = 'rgba(230, 126, 34, 0.2)' %}
    {% elseif statistics[0].statisticType == 'CA_JOURNALIER' %}
        {% set statTitle = "Chiffre d'Affaires" %}
        {% set caption = "Revenus (‚Ç¨)" %}
        {% set toEuros = 100 %}
        {% set euroSign = ' ‚Ç¨' %}
        {% set chartColor = '#27ae60' %}
        {% set chartBgColor = 'rgba(39, 174, 96, 0.2)' %}
    {% endif %}
{% endif %}

{% block title %} {{ statTitle }} - {{ restaurant.name }}{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {# --- Chargement des scripts --- #}
    {# 1. La librairie Chart.js #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    {# 2. Notre script personnalis√© (Type module pour utiliser import/export) #}
    <script type="module">
        import { initChart } from "{{ asset('js/chart-handler.js') }}";

        // On lance l'initialisation d√®s que le HTML est pr√™t
        document.addEventListener('DOMContentLoaded', () => {
            initChart('myChart');
        });
    </script>
{% endblock %}

{% block main %}
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="h3 fw-bold mb-0">{{ statTitle }}</h2>
                    <a href="{{ path('app_statistic', {id : restaurant.id}) }}" class="btn btn-outline-secondary btn-sm">
                        ‚Üê Retour
                    </a>
                </div>

                <div class="card shadow border-0">
                    <div class="card-body p-4">

                        {% if statistics is empty %}
                            <div class="text-center py-5">
                                <div class="fs-1 mb-3 text-muted">üìä</div>
                                <h4 class="text-muted">Aucune donn√©e disponible</h4>
                                <p class="text-secondary small">
                                    Il n'y a pas encore eu d'activit√© pour cette cat√©gorie.
                                </p>
                            </div>
                        {% else %}

                            {# Pr√©paration des tableaux de donn√©es #}
                            {% set dates = [] %}
                            {% set values = [] %}
                            {% for element in statistics %}
                                {% set dates = dates|merge([element.date|date('d/m')]) %}
                                {% set values = values|merge([element.value / toEuros]) %}
                            {% endfor %}

                            {#
                            LE CANVAS MAGIQUE :
                            On injecte les donn√©es JSON dans les attributs data-*
                            #}
                            <div style="position: relative; height: 400px; width: 100%;">
                                <canvas id="myChart"
                                        data-dates="{{ dates|json_encode }}"
                                        data-values="{{ values|json_encode }}"
                                        data-caption="{{ caption }}"
                                        data-color="{{ chartColor }}"
                                        data-bgcolor="{{ chartBgColor }}"
                                ></canvas>
                            </div>

                        {% endif %}

                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
